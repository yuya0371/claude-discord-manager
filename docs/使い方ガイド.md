# Claude Code Discord Manager 使い方ガイド

Discord から Claude Code CLI をリモート操作・管理するための Bot です。
本ドキュメントでは、全コマンドと機能の使い方を説明します。

---

## 目次

1. [チャンネル構成](#チャンネル構成)
2. [コマンド一覧](#コマンド一覧)
   - [/task](#task---タスク依頼)
   - [/workers](#workers---worker一覧)
   - [/status](#status---タスク状況)
   - [/cancel](#cancel---タスクキャンセル)
   - [/alias](#alias---プロジェクトエイリアス管理)
   - [/token](#token---トークン使用量)
   - [/teams](#teams---agent-teams一覧)
   - [/notify](#notify---通知レベル設定)
   - [/schedule](#schedule---定期タスク管理)
   - [/help](#help---ヘルプ表示)
3. [権限モード](#権限モード)
4. [インタラクティブ応答](#インタラクティブ応答)
5. [セッション継続](#セッション継続)
6. [ファイル添付](#ファイル添付)
7. [定期タスクのテンプレート変数](#定期タスクのテンプレート変数)
8. [表示の見方](#表示の見方)

---

## チャンネル構成

Bot は以下の Discord チャンネルを使い分けます。

| チャンネル | 用途 |
|-----------|------|
| `#command` | コマンド入力・操作を行うメインチャンネル |
| `#status` | タスクのリアルタイム状況を自動投稿（Embed が随時更新される） |
| `#token-usage` | タスク完了時のトークン消費量を自動投稿 |
| `#teams` | Agent Teams の活動状況を自動投稿 |
| `#workers` | Worker の接続・切断通知を自動投稿 |
| `#scheduled` | 定期タスクの実行結果を自動投稿 |

---

## コマンド一覧

### `/task` - タスク依頼

Claude Code にタスクを依頼します。最も使用頻度の高いメインコマンドです。

#### オプション

| オプション | 必須 | 説明 |
|-----------|------|------|
| `prompt` | Yes | Claude に送るプロンプト |
| `worker` | No | 実行先の Worker 名（オートコンプリート対応。省略時は空いている Worker に自動振り分け） |
| `directory` | No | 作業ディレクトリのパス、または `@エイリアス名` |
| `mode` | No | 権限モード（`acceptEdits` / `auto` / `confirm`）。省略時は `acceptEdits` |
| `team` | No | `True` にすると Agent Teams モードで実行 |
| `continue` | No | `True` にすると前回のセッションを継続（同じ Worker・ディレクトリの直近セッション） |
| `attachment` | No | 添付ファイル（8MB 以下） |

#### 使用例

```
/task prompt:auth.pyのバグを修正して
/task prompt:テストを書いて worker:MacBook-Air directory:/Users/me/project
/task prompt:このコードをレビューして directory:@競馬
/task prompt:さっきの続きで、テストも追加して continue:True
/task prompt:このファイルを分析して attachment:data.csv
/task prompt:大規模リファクタリング team:True mode:auto
```

> **Tips**: `directory` に `@エイリアス名` を指定すると、登録済みのプロジェクトエイリアスのパスに解決されます。エイリアスに優先 Worker が設定されている場合、`worker` 省略時にその Worker が自動選択されます。

---

### `/workers` - Worker 一覧

接続中の Worker の一覧と状態を表示します。

#### 表示内容

- Worker 名
- ステータス（🟢 Online / 🟡 Busy / ⚫ Offline）
- OS、Node.js バージョン、Claude CLI バージョン
- 接続時間、最終ハートビート
- 実行中のタスク ID（Busy の場合）

```
/workers
```

---

### `/status` - タスク状況

タスクの実行状況を確認します。

#### オプション

| オプション | 必須 | 説明 |
|-----------|------|------|
| `task_id` | No | 特定タスクの詳細を表示。省略時は全体の一覧を表示 |

#### 使用例

```
/status                    → 実行中・キュー・直近完了タスクの一覧
/status task_id:task-5     → task-5 の詳細な Embed を表示
```

一覧表示では以下のセクションが表示されます:
- **Running**: 現在実行中のタスク
- **Queued**: キュー内で待機中のタスク
- **Recent**: 直近 5 件の完了・失敗・キャンセルされたタスク
- **Sessions**: セッション継続可能なタスク

---

### `/cancel` - タスクキャンセル

実行中またはキュー内のタスクをキャンセルします。

| オプション | 必須 | 説明 |
|-----------|------|------|
| `task_id` | Yes | キャンセルするタスクの ID |

```
/cancel task_id:task-3
```

> 完了済み・失敗済み・キャンセル済みのタスクに対してはキャンセルできません。

---

### `/alias` - プロジェクトエイリアス管理

プロジェクト名のショートカット（エイリアス）を管理します。
`/task` コマンドの `directory` オプションで `@エイリアス名` として使えます。

#### サブコマンド

#### `/alias add` - エイリアス追加

| オプション | 必須 | 説明 |
|-----------|------|------|
| `name` | Yes | エイリアス名（例: `競馬`） |
| `path` | Yes | プロジェクトのフルパス（例: `/Users/me/projects/keiba`） |
| `worker` | No | このプロジェクトの優先 Worker 名 |

```
/alias add name:競馬 path:/Users/me/projects/keiba worker:MacBook-Air
```

#### `/alias remove` - エイリアス削除

| オプション | 必須 | 説明 |
|-----------|------|------|
| `name` | Yes | 削除するエイリアス名 |

```
/alias remove name:競馬
```

#### `/alias list` - エイリアス一覧

登録済みのエイリアスをすべて表示します。

```
/alias list
```

---

### `/token` - トークン使用量

トークンの使用量を確認します。

#### オプション

| オプション | 必須 | 説明 |
|-----------|------|------|
| `view` | No | 表示モード（省略時は `summary`） |

#### 表示モード

| モード | 説明 |
|--------|------|
| `summary` | 今日の合計と累計のサマリー（Input / Output / Cache Read / Cache Write） |
| `detail` | タスク別の使用量（直近 20 件） |
| `worker` | Worker 別の使用量 |

```
/token                → サマリー表示
/token view:detail    → タスク別詳細
/token view:worker    → Worker 別
```

> Coordinator を再起動すると累計データはリセットされます。

---

### `/teams` - Agent Teams 一覧

アクティブな Agent Teams の一覧を表示します。

```
/teams
```

#### 表示内容

- チーム名
- 所属 Worker
- メンバー一覧と各メンバーのステータス
- タスクの完了数 / 総数 / 実行中数

> Teams は `/task` コマンドで `team:True` を指定して実行したタスクで作成されます。
> Teams の詳細な活動ログは `#teams` チャンネルに自動投稿されます。

---

### `/notify` - 通知レベル設定

@メンション通知のレベルを設定します。ユーザーごとに個別設定可能です。

| オプション | 必須 | 説明 |
|-----------|------|------|
| `level` | Yes | 通知レベル |

#### 通知レベル

| レベル | 説明 |
|--------|------|
| `all` | タスク完了・エラー・質問の全イベントで @メンション |
| `important` | エラーと確認質問のときのみ @メンション（**デフォルト**） |
| `none` | @メンションなし（メッセージ自体は投稿される） |

```
/notify level:important
```

---

### `/schedule` - 定期タスク管理

cron 式でスケジュールされた定期タスクを管理します。
指定した時刻に自動でプロンプトを実行し、結果を `#scheduled` チャンネルに投稿します。

#### `/schedule add` - スケジュール追加

| オプション | 必須 | 説明 |
|-----------|------|------|
| `name` | Yes | スケジュール名（例: `朝のAI記事`） |
| `cron` | Yes | cron 式（例: `0 8 * * *` → 毎朝8時） |
| `prompt` | Yes | 実行プロンプト（テンプレート変数使用可） |
| `worker` | No | 実行先 Worker 名（オートコンプリート対応） |
| `directory` | No | 作業ディレクトリまたは `@エイリアス名` |

```
/schedule add name:朝のAI記事 cron:0 8 * * * prompt:今日は{{date}}（{{weekday}}）です。AI関連ニュースを検索してまとめてください。
```

#### cron 式の書き方

```
┌───────── 分 (0-59)
│ ┌─────── 時 (0-23)
│ │ ┌───── 日 (1-31)
│ │ │ ┌─── 月 (1-12)
│ │ │ │ ┌─ 曜日 (0-7, 0と7は日曜日)
│ │ │ │ │
* * * * *
```

| 例 | 説明 |
|----|------|
| `0 8 * * *` | 毎朝 8:00 |
| `0 8 * * 1-5` | 平日 8:00 |
| `30 12 * * *` | 毎日 12:30 |
| `0 9,18 * * *` | 毎日 9:00 と 18:00 |
| `*/30 * * * *` | 30分おき |
| `0 0 1 * *` | 毎月 1 日 0:00 |

> タイムゾーンは `Asia/Tokyo` です。

#### `/schedule remove` - スケジュール削除

| オプション | 必須 | 説明 |
|-----------|------|------|
| `name` | Yes | 削除するスケジュール名（オートコンプリート対応） |

```
/schedule remove name:朝のAI記事
```

#### `/schedule list` - スケジュール一覧

全スケジュールの一覧を Embed で表示します。

```
/schedule list
```

表示内容: 名前、有効/無効、cron 式、Worker、最終実行日時、プロンプト（先頭80文字）

#### `/schedule toggle` - 有効/無効切替

| オプション | 必須 | 説明 |
|-----------|------|------|
| `name` | Yes | 切り替えるスケジュール名（オートコンプリート対応） |

```
/schedule toggle name:朝のAI記事
```

#### `/schedule run` - 手動即時実行

スケジュールを今すぐ実行します（cron 時刻を待たない）。

| オプション | 必須 | 説明 |
|-----------|------|------|
| `name` | Yes | 実行するスケジュール名（オートコンプリート対応） |

```
/schedule run name:朝のAI記事
```

---

### `/help` - ヘルプ表示

全コマンドの簡易リファレンスを Embed で表示します。

```
/help
```

---

## 権限モード

タスク実行時の Claude Code CLI の権限レベルを制御します。
`/task` コマンドの `mode` オプション、または `/schedule` の定期タスク（常に `auto`）で使用されます。

| モード | ファイル編集 | Bash 実行 | 用途 |
|--------|------------|-----------|------|
| `acceptEdits`（デフォルト） | 自動許可 | Discord で確認 | 通常の開発作業に推奨 |
| `auto` | 自動許可 | 自動許可 | 信頼できるタスク・定期タスク向け |
| `confirm` | Discord で確認 | Discord で確認 | 慎重に実行したいとき |

---

## インタラクティブ応答

タスク実行中に Claude Code がユーザーに確認を求める場合があります。

### Bash 実行の許可確認

権限モードが `acceptEdits` または `confirm` の場合、Bash コマンド実行前に Discord でボタンが表示されます。

```
⚠️ Task #12: Bash実行確認
━━━━━━━━━━━━━━━━━━━━━
$ npm run test -- --coverage
━━━━━━━━━━━━━━━━━━━━━
📝 要約: テストをカバレッジ付きで実行する
🟢 リスク: 安全
━━━━━━━━━━━━━━━━━━━━━
[✅ 許可] [❌ 拒否]
```

- **許可**: ボタンを押すとコマンドが実行されます
- **拒否**: ボタンを押すとコマンドの実行がスキップされます
- タイムアウト: **3分**以内に応答しないと自動拒否

### Claude からの質問応答

Claude Code が作業中にユーザーに質問する場合:

- **選択肢付き質問**: Discord のボタンで選択します
- **自由入力**: モーダルダイアログで入力します
- タイムアウト: **5分**以内に応答が必要

---

## セッション継続

タスク完了後、同じ会話コンテキストを引き継いで作業を続けることができます。

### 使い方

1. まず通常のタスクを実行する
   ```
   /task prompt:auth.pyのバグを調査して
   ```

2. 完了後の Embed に `Session` フィールドが表示される

3. `continue:True` で前回の続きから実行
   ```
   /task prompt:さっきの修正案を実装して continue:True
   ```

> セッション継続は同じ Worker・同じ作業ディレクトリの直近完了タスクを自動検出します。
> Worker や directory を明示指定すると、その条件にマッチするセッションが使われます。

---

## ファイル添付

Discord の添付ファイル機能を使って、ファイルを Claude に渡すことができます。

### 対応ファイル

- テキストファイル（.py, .ts, .md 等）
- 画像（.png, .jpg 等）
- PDF
- その他（Discord のアップロード上限 **8MB** に準拠）

### 使い方

1. `/task` コマンドの `attachment` オプションにファイルをドラッグ&ドロップ

```
/task prompt:このコードをレビューして attachment:main.py
/task prompt:このスクリーンショットのバグを調査して attachment:screenshot.png
```

> 添付ファイルは Worker 上の一時ディレクトリに転送され、タスク完了後にクリーンアップされます。

---

## 定期タスクのテンプレート変数

`/schedule add` のプロンプト内で以下のテンプレート変数を使えます。
実行時に実際の日時に自動置換されます。

| 変数 | 例 | 説明 |
|------|---|------|
| `{{date}}` | `2026-02-26` | 実行日（YYYY-MM-DD） |
| `{{datetime}}` | `2026-02-26 08:00` | 実行日時（YYYY-MM-DD HH:mm） |
| `{{weekday}}` | `水曜日` | 曜日（日本語） |

### プロンプト例

```
今日は{{date}}（{{weekday}}）です。
AI・LLM関連の最新ニュースを検索し、以下を生成してください:
1. X投稿案（3〜5件、各140文字以内）
2. note記事の下書き（1500〜2000文字）
```

---

## 表示の見方

### タスク Embed（#status チャンネル）

タスクの状態に応じて色が変わります:

| 色 | 状態 | アイコン |
|----|------|---------|
| 🟡 黄 | Queued（キュー待ち） | ⏳ |
| 🔵 青 | Running（実行中） | 🔄 |
| 🟢 緑 | Completed（完了） | ✅ |
| 🔴 赤 | Failed（失敗） | ❌ |
| ⚪ 灰 | Cancelled（キャンセル） | 🚫 |

Embed には以下の情報が表示されます:
- **Prompt**: 送信したプロンプト
- **Worker**: 実行中の Worker 名
- **Mode**: 権限モード
- **Tools**: Claude が使用したツールの履歴（最新10件、リアルタイム更新）
- **Result**: 完了時の結果テキスト（2000文字超はスレッドに展開）
- **Tokens**: Input / Output のトークン数
- **Duration**: 実行時間
- **Session**: セッション ID（継続可能な場合のみ）

### Worker 接続通知（#workers チャンネル）

```
✅ Worker Connected: MacBook-Air
  OS: darwin 25.2.0
  Node.js: v22.x.x
  Claude CLI: 1.x.x
  Default CWD: /Users/me/Documents/program
```

### トークン使用量通知（#token-usage チャンネル）

タスク完了ごとにトークン使用量が自動投稿されます:
- Total（合計）
- Input / Output の内訳
- Cache Read / Cache Write

### 定期タスク結果（#scheduled チャンネル）

定期タスクの実行結果は専用の Embed で投稿されます。
結果が長文の場合はスレッドに展開されます。

---

## 環境変数

Coordinator の `.env` ファイルで設定します。

| 変数名 | 説明 |
|--------|------|
| `DISCORD_BOT_TOKEN` | Discord Bot のトークン |
| `GUILD_ID` | Discord サーバー（ギルド）の ID |
| `ALLOWED_USER_IDS` | 操作を許可するユーザー ID（カンマ区切りで複数可） |
| `CHANNEL_COMMAND` | #command チャンネルの ID |
| `CHANNEL_STATUS` | #status チャンネルの ID |
| `CHANNEL_TOKEN_USAGE` | #token-usage チャンネルの ID |
| `CHANNEL_TEAMS` | #teams チャンネルの ID |
| `CHANNEL_WORKERS` | #workers チャンネルの ID |
| `CHANNEL_SCHEDULED` | #scheduled チャンネルの ID |
| `WS_PORT` | WebSocket サーバーのポート（デフォルト: 8765） |
| `COORDINATOR_SECRET` | Worker 接続時の認証シークレット |

Worker の `.env` ファイル:

| 変数名 | 説明 |
|--------|------|
| `COORDINATOR_URL` | Coordinator の WebSocket URL（例: `ws://192.168.11.31:8765`） |
| `COORDINATOR_SECRET` | Coordinator と同じ認証シークレット |
| `WORKER_NAME` | この Worker の名前 |
| `DEFAULT_CWD` | デフォルトの作業ディレクトリ |
